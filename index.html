<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Contenido Moderno üì∫</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <aside id="sidebar">
            <h2>Playlist ‚èØÔ∏è</h2>
            <ul id="sidebar-playlist">
                <li>Cargando lista...</li>
            </ul>
        </aside>
        <main id="display-area">
            <!-- El contenido se insertar√° aqu√≠ -->
        </main>
    </div>

    <!-- Carga as√≠ncrona de la API de YouTube -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- SDK de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // ---------------------------------------------------------------
        // --- CONFIGURACI√ìN DE FIREBASE (TUS CREDENCIALES) ---
        // ---------------------------------------------------------------
        const firebaseConfig = {
          apiKey: "AIzaSyAir6pUHwf-vCJ7Tt8yDBpmw4n1jml7oE8",
          authDomain: "visor-negocio.firebaseapp.com",
          databaseURL: "https://visor-negocio-default-rtdb.firebaseio.com",
          projectId: "visor-negocio",
          storageBucket: "visor-negocio.appspot.com", // Corregido: suele ser .appspot.com
          messagingSenderId: "113061044521",
          appId: "1:113061044521:web:a397b454b03b27da041738"
        };
        // ---------------------------------------------------------------

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const playlistRef = database.ref('playlist');

        let currentPlaylist = [];
        let currentItemIndex = 0;
        let currentTimeoutId = null;
        const displayArea = document.getElementById('display-area');
        const sidebarListUl = document.getElementById('sidebar-playlist'); // Referencia a la lista del sidebar

        let ytPlayer;
        let youtubeApiReady = false;

        function onYouTubeIframeAPIReady() {
            console.log("YouTube API Lista.");
            youtubeApiReady = true;
            // No iniciar play aqu√≠, esperar al flujo normal
        }

        function extractVideoID(url) {
             try {
                const urlObj = new URL(url);
                 // Simplificado para manejar varios formatos de YouTube
                 let videoId = urlObj.searchParams.get('v'); // Est√°ndar ?v=...
                 if (!videoId && urlObj.hostname === 'youtu.be') {
                    videoId = urlObj.pathname.slice(1); // Formato corto youtu.be/...
                 }
                 if (videoId && videoId.length === 11) return videoId; // Validaci√≥n b√°sica de longitud
            } catch (e) { console.error("Error parseando URL YT:", url, e); }
             // Fallback si solo es ID o algo raro
            if (typeof url === 'string' && url.length === 11 && !url.includes('/')) return url;
            return null;
        }

        function cleanupPreviousPlayer() {
            if (currentTimeoutId) clearTimeout(currentTimeoutId);
            currentTimeoutId = null;
            if (ytPlayer && typeof ytPlayer.destroy === 'function') {
                try { ytPlayer.destroy(); console.log("Reproductor YT destruido."); }
                catch(e) { console.error("Error destruyendo YT:", e); }
                ytPlayer = null;
            }
            displayArea.innerHTML = '<div style="width:100%; height:100%; background:black;"></div>'; // Fondo negro por defecto
        }

        // --- Funci√≥n para renderizar la playlist en el sidebar ---
        function renderSidebarPlaylist() {
            sidebarListUl.innerHTML = ''; // Limpiar
            if (currentPlaylist.length === 0) {
                sidebarListUl.innerHTML = '<li>Lista vac√≠a...</li>';
                return;
            }
            currentPlaylist.forEach((item, index) => {
                const li = document.createElement('li');
                li.dataset.index = index; // Guardar √≠ndice para referencia
                let emoji = '‚ùì';
                switch(item.type) {
                    case 'image': emoji = 'üñºÔ∏è'; break;
                    case 'video': emoji = 'üé¨'; break;
                    case 'webpage': emoji = 'üåê'; break;
                    case 'youtube': emoji = 'üìπ'; break; // Podr√≠a ser el de YouTube
                }
                let displayText = item.url;
                 // Intentar mostrar algo m√°s amigable que la URL
                 try {
                    const urlObj = new URL(item.url);
                     if (item.type === 'youtube' && item.url.includes('yout')) {
                         displayText = `YouTube Video`; // O extraer t√≠tulo si pudi√©ramos (m√°s complejo)
                     } else if(item.type === 'image' || item.type === 'video') {
                        displayText = urlObj.pathname.split('/').pop() || item.url; // Intentar obtener nombre de archivo
                     } else if(item.type === 'webpage') {
                        displayText = urlObj.hostname; // Mostrar dominio
                     }
                 } catch (e) { /* Usar URL completa si falla */ }

                 if (displayText.length > 25) { // Acortar si es muy largo
                    displayText = displayText.substring(0, 22) + '...';
                 }

                li.innerHTML = `${emoji} ${displayText}`;
                 li.title = item.url; // Tooltip con URL completa
                sidebarListUl.appendChild(li);
            });
        }

         // --- Funci√≥n para marcar el item activo en el sidebar ---
         function setActiveSidebarItem(index) {
            const items = sidebarListUl.querySelectorAll('li');
            items.forEach((li, i) => {
                if (i === index) {
                    li.classList.add('active');
                    // Scroll para que sea visible si la lista es larga
                    li.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    li.classList.remove('active');
                }
            });
         }


        function playNextItem() {
            cleanupPreviousPlayer();

            if (!currentPlaylist || currentPlaylist.length === 0) {
                console.log("Playlist vac√≠a.");
                sidebarListUl.innerHTML = '<li>Esperando contenido...</li>';
                currentTimeoutId = setTimeout(playNextItem, 5000);
                return;
            }

            if (currentItemIndex >= currentPlaylist.length) {
                currentItemIndex = 0; // Loop
            }

            setActiveSidebarItem(currentItemIndex); // Marcar activo en sidebar
            const item = currentPlaylist[currentItemIndex];
            console.log(`Mostrando item ${currentItemIndex}: ${item.url} (Tipo: ${item.type})`);

            let advanceIndex = true; // Por defecto, avanzamos √≠ndice para el siguiente

            switch (item.type) {
                case 'image':
                    const img = document.createElement('img');
                    img.src = item.url;
                    img.onerror = () => { console.error("Error img:", item.url); playNextItem(); }; // Avanza al siguiente en error
                    displayArea.innerHTML = ''; // Limpiar antes de a√±adir
                    displayArea.appendChild(img);
                    currentTimeoutId = setTimeout(playNextItem, item.duration * 1000);
                    break;

                case 'video':
                    const video = document.createElement('video');
                    video.src = item.url;
                    video.autoplay = true;
                    video.muted = false; // Intentar con sonido (puede fallar autoplay)
                    video.controls = false;
                    video.onerror = () => { console.error("Error video:", item.url); playNextItem(); };
                    video.addEventListener('ended', playNextItem);
                     video.addEventListener('error', playNextItem); // Tambien avanzar si hay error en play
                    displayArea.innerHTML = '';
                    displayArea.appendChild(video);
                    advanceIndex = false; // El evento 'ended' se encarga de avanzar
                    break;

                case 'webpage':
                    const iframe = document.createElement('iframe');
                    iframe.src = item.url;
                    // Ojo: X-Frame-Options puede impedir mostrar muchas webs
                    iframe.onerror = () => { console.warn("Error iframe:", item.url); };
                    displayArea.innerHTML = '';
                    displayArea.appendChild(iframe);
                    currentTimeoutId = setTimeout(playNextItem, item.duration * 1000);
                    break;

                case 'youtube':
                    const videoId = extractVideoID(item.url);
                    if (!videoId) {
                        console.error("No se pudo obtener Video ID de:", item.url);
                        setTimeout(playNextItem, 100); break; // Avanzar
                    }
                    if (!youtubeApiReady) {
                        console.warn("API YouTube no lista, reintentando...");
                        setActiveSidebarItem(-1); // Desmarcar activo mientras espera
                        currentTimeoutId = setTimeout(playNextItem, 1000); // Reintentar este mismo item
                        advanceIndex = false; // No avanzar √≠ndice todav√≠a
                        break;
                    }
                    const ytDiv = document.createElement('div');
                    ytDiv.id = 'youtube-player-container';
                    displayArea.innerHTML = '';
                    displayArea.appendChild(ytDiv);
                    ytPlayer = new YT.Player('youtube-player-container', {
                        height: '100%', width: '100%', videoId: videoId,
                        playerVars: {
                            'autoplay': 1, 'controls': 0, 'showinfo': 0, 'rel': 0,
                            'modestbranding': 1, 'loop': 0, 'fs': 0, 'cc_load_policy': 0,
                            'iv_load_policy': 3, 'autohide': 0,
                            'mute': 0 // <--- INTENTANDO CON SONIDO (puede fallar autoplay)
                        },
                        events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange, 'onError': onPlayerError }
                    });
                    advanceIndex = false; // El evento state change (ended) avanzar√°
                    break;

                default:
                    console.warn("Tipo desconocido:", item.type);
                    setTimeout(playNextItem, 100); // Avanzar r√°pido
                    break;
            }

            if(advanceIndex) {
                currentItemIndex++; // Incrementar para la pr√≥xima llamada (solo si no es video/YT)
            }
        }

        function onPlayerReady(event) {
            console.log("YT Player listo:", event.target.getVideoData().title);
            // No necesitamos playVideo() si autoplay=1, pero s√≠ necesitamos asegurar el mute state
             // event.target.mute(); // Si quisi√©ramos forzar mute
            // event.target.unMute(); // Si quisi√©ramos intentar activar sonido (con riesgo)
             event.target.playVideo(); // Llamarlo expl√≠citamente puede ayudar en algunos casos
        }

        function onPlayerStateChange(event) {
            // Estado -1 (unstarted), 0 (ended), 1 (playing), 2 (paused), 3 (buffering), 5 (video cued)
            if (event.data == YT.PlayerState.ENDED) {
                console.log("Video YT finalizado.");
                currentItemIndex++;
                playNextItem();
            }
             // Podr√≠amos detectar si falla el play autom√°tico por sonido aqu√≠?
             if (event.data == YT.PlayerState.UNSTARTED && event.target.getPlayerState() == YT.PlayerState.UNSTARTED) {
                console.warn("Video YT parece no haber iniciado autom√°ticamente (¬øproblema de autoplay con sonido?).")
                // Podr√≠amos intentar silenciarlo aqu√≠ y darle play de nuevo?
                // event.target.mute(); event.target.playVideo();
                // O simplemente avanzar? Por ahora, solo avisamos.
             }
        }

        function onPlayerError(event) {
            console.error("Error en YT player:", event.data, "para item:", currentPlaylist[currentItemIndex]?.url);
            currentItemIndex++;
            playNextItem(); // Saltar al siguiente
        }

        playlistRef.on('value', (snapshot) => {
            const data = snapshot.val();
            currentPlaylist = data ? Object.values(data) : [];
            console.log("Playlist actualizada:", currentPlaylist);
            renderSidebarPlaylist(); // Actualizar sidebar
            currentItemIndex = 0; // Reiniciar al recibir nueva lista
            if (document.readyState === 'complete') { // Solo iniciar si la p√°g ya carg√≥
                 playNextItem();
            } else {
                 window.addEventListener('load', playNextItem, { once: true }); // Esperar a que todo cargue
            }
        }, (error) => {
            console.error("Error leyendo Firebase:", error);
            displayArea.innerHTML = '<p style="color: red;">Error conectando a DB.</p>';
             sidebarListUl.innerHTML = '<li>Error DB</li>';
        });

         // Iniciar la reproducci√≥n cuando la ventana est√© cargada
         // window.addEventListener('load', playNextItem, { once: true }); // Movido dentro del listener de Firebase

    </script>
</body>
</html>