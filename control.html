<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control 🔒 Admin</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="control-page">

    <h1>Panel de Control de Contenido</h1>

    <!-- Sección de Login -->
    <div id="login-section" class="control-section">
       <!-- ... (contenido del login sin cambios) ... -->
    </div>

    <!-- Sección de Controles -->
    <div id="controls-section" style="display: none;">
        <!-- ... (contenido de los controles sin cambios) ... -->
        <div class="control-section">
            <h2>Lista de Reproducción Actual 📋</h2>
            <ul id="playlist-list">
                <li>Inicia sesión como administrador para ver/editar...</li>
            </ul>
             <p><small>⚠️ Mover/Eliminar podría requerir recarga en la TV si ya empezó a mostrarse.</small></p>
        </div>
    </div>

    <!-- SDKs Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // --- CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = { /* ... tus credenciales ... */ };
        // --- UID del Administrador ---
        const ADMIN_UID = "eRKsZnCe0TXZ4JagmcVAik7IX8T2";
        // -----------------------------

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const playlistRef = database.ref('playlist');

        // Referencias DOM
        const loginSection = document.getElementById('login-section');
        const controlsSection = document.getElementById('controls-section');
        // ... (resto de refs DOM) ...
        const playlistListUl = document.getElementById('playlist-list');

        let currentPlaylist = [];
        let dbListenerActive = false;

        // --- Funciones Auth (Login/Logout sin cambios) ---
        // ...

        // --- Observador de Auth con VERIFICACIÓN DE UID ---
        auth.onAuthStateChanged(user => {
            console.log("Auth state changed. User:", user ? user.email : 'No user'); // <-- AÑADIR LOG

            if (user && user.uid === ADMIN_UID) {
                console.log("ADMINISTRADOR CORRECTO autenticado. UID:", user.uid); // <-- AÑADIR LOG
                loginSection.style.display = 'none';
                controlsSection.style.display = 'block';
                // ... (actualizar UI) ...

                if (!dbListenerActive) {
                    console.log("Intentando activar listener de DB..."); // <-- AÑADIR LOG
                    activateDbRead();
                    dbListenerActive = true;
                } else {
                    console.log("Listener de DB ya estaba activo."); // <-- AÑADIR LOG
                }
            } else {
                console.log("Usuario NO es admin o no está logueado."); // <-- AÑADIR LOG
                 if (user) {
                     console.warn("Usuario logueado NO es admin:", user.uid, "!===", ADMIN_UID); // <-- AÑADIR LOG
                     // ... (manejar usuario no admin logueado, forzar logout) ...
                 }
                 // ... (ocultar controles, mostrar login) ...

                if (dbListenerActive) {
                    console.log("Desactivando listener de DB..."); // <-- AÑADIR LOG
                    playlistRef.off('value');
                    dbListenerActive = false;
                }
                 playlistListUl.innerHTML = '<li>Inicia sesión como administrador para ver/editar...</li>'; // Limpiar lista explícitamente
                 currentPlaylist = [];
            }
        });

        // --- Funciones Playlist ---
        function renderPlaylist() {
            console.log("Intentando renderizar playlist. Datos actuales:", currentPlaylist); // <-- AÑADIR LOG
            playlistListUl.innerHTML = '';
            if (currentPlaylist.length === 0) {
                console.log("Renderizando: Lista vacía."); // <-- AÑADIR LOG
                playlistListUl.innerHTML = '<li>La lista está vacía. ¡Añade algo!</li>';
                return;
            }
            currentPlaylist.forEach((item, index) => {
                 console.log("Renderizando item:", index, item); // <-- AÑADIR LOG
                 // ... (código para crear el li) ...
                 playlistListUl.appendChild(li);
            });
        }

        // ... (resto de funciones: save, add, delete, move, extractVideoID, toggleDuration) ...

        // --- Listener de Base de Datos ---
        function activateDbRead() {
             console.log(">>> Dentro de activateDbRead: Adjuntando listener a 'playlist'..."); // <-- AÑADIR LOG
             playlistRef.on('value', (snapshot) => {
                console.log(">>> Listener DB: Datos recibidos de Firebase!"); // <-- AÑADIR LOG
                const data = snapshot.val();
                console.log(">>> Listener DB: snapshot.val():", data); // <-- AÑADIR LOG
                currentPlaylist = data ? Object.values(data) : [];
                console.log(">>> Listener DB: currentPlaylist procesada:", currentPlaylist); // <-- AÑADIR LOG
                renderPlaylist(); // Renderizar la lista con los datos recibidos
            }, (error) => {
                // ¡Este bloque es IMPORTANTE si hay error de lectura!
                console.error(">>> !!! ERROR en listener de DB:", error.code, error.message); // <-- AÑADIR LOG MÁS DETALLADO
                playlistListUl.innerHTML = `<li>ERROR AL LEER DATOS: ${error.message} (Código: ${error.code})</li>`;
                // Podríamos intentar desactivar el listener aquí si falla repetidamente
                // playlistRef.off('value');
                // dbListenerActive = false;
            });
        }

    </script>
</body>
</html>