<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Matrix üïπÔ∏è</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="control-page">
    <header class="main-header">
        <h1><span class="glow-text">CONTROL</span>_MATRIX</h1>
        <p class="subtitle">Interfaz de gesti√≥n de contenido visual</p>
    </header>

    <div class="control-section add-item-section">
        <h2><span class="icon">‚ûï</span> Inyectar Nuevo Contenido</h2>
        <label for="item-url">URL del Recurso (Datastream):</label>
        <input type="url" id="item-url" placeholder="https://... o https://www.youtube.com/watch?v=..." required>

        <label for="item-type">Tipo de Transmisi√≥n:</label>
        <select id="item-type">
            <option value="image">üñºÔ∏è Holograma Est√°tico (Imagen)</option>
            <option value="video">üé¨ Secuencia Cin√©tica (Video MP4)</option>
            <option value="webpage">üåê Portal Dimensional (P√°gina Web)</option>
            <option value="youtube">üìπ Canal YouTube (Video Stream)</option>
        </select>

        <label for="item-duration" id="duration-label">Duraci√≥n de Exposici√≥n (seg, para Holograma/Portal):</label>
        <input type="number" id="item-duration" value="10" min="1">

        <button id="add-item-btn" class="primary-button"><span class="icon">‚ö°</span> A√±adir a la Secuencia</button>
    </div>

    <div class="control-section playlist-section">
        <h2><span class="icon">üìú</span> Secuencia de Transmisi√≥n Actual</h2>
        <ul id="playlist-list">
            <li>Analizando flujo de datos...</li>
        </ul>
        <p class="info-text"><em><span class="icon">üîÑ</span> Cambios sincronizados en tiempo real con el visor.</em></p>
    </div>

    <footer class="main-footer">
        <p>&copy; 2077 VisorCorp Systems - Alpha Build</p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // --- CONFIGURACI√ìN FIREBASE (TUS CREDENCIALES) ---
        const firebaseConfig = {
          apiKey: "AIzaSyAir6pUHwf-vCJ7Tt8yDBpmw4n1jml7oE8",
          authDomain: "visor-negocio.firebaseapp.com",
          databaseURL: "https://visor-negocio-default-rtdb.firebaseio.com",
          projectId: "visor-negocio",
          storageBucket: "visor-negocio.appspot.com",
          messagingSenderId: "113061044521",
          appId: "1:113061044521:web:a397b454b03b27da041738"
        };
        // --------------------------------------------------

        // El Javascript aqu√≠ es el mismo que en la respuesta anterior
        // (Inicializaci√≥n de Firebase, listeners, funciones add/delete/move, etc.)
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const playlistRef = database.ref('playlist');

        const itemUrlInput = document.getElementById('item-url');
        const itemTypeSelect = document.getElementById('item-type');
        const itemDurationInput = document.getElementById('item-duration');
        const durationLabel = document.getElementById('duration-label');
        const addItemBtn = document.getElementById('add-item-btn');
        const playlistListUl = document.getElementById('playlist-list');

        let currentPlaylist = [];

        function toggleDurationInput() {
            const selectedType = itemTypeSelect.value;
            if (selectedType === 'video' || selectedType === 'youtube') {
                itemDurationInput.style.display = 'none';
                durationLabel.style.display = 'none';
            } else {
                itemDurationInput.style.display = 'block';
                durationLabel.style.display = 'block';
            }
        }
        itemTypeSelect.addEventListener('change', toggleDurationInput);
        toggleDurationInput();

        function renderPlaylist() {
            playlistListUl.innerHTML = '';
            if (currentPlaylist.length === 0) {
                playlistListUl.innerHTML = '<li class="empty-list-item">Secuencia vac√≠a. Esperando inyecci√≥n de datos...</li>';
                return;
            }

            currentPlaylist.forEach((item, index) => {
                const li = document.createElement('li');
                 let durationText = '';
                 if (item.type !== 'video' && item.type !== 'youtube') {
                    durationText = ` <span class="duration-tag">(${item.duration}s)</span>`;
                 }
                 let displayUrl = item.url;
                 if (displayUrl.length > 40) { // Acortar un poco m√°s para el nuevo estilo
                    displayUrl = displayUrl.substring(0, 37) + '...';
                 }
                 let itemIcon = '‚ùì';
                 switch(item.type) {
                    case 'image': itemIcon = 'üñºÔ∏è'; break;
                    case 'video': itemIcon = 'üé¨'; break;
                    case 'webpage': itemIcon = 'üåê'; break;
                    case 'youtube': itemIcon = 'üìπ'; break;
                 }


                li.innerHTML = `
                    <div class="item-info">
                        <span class="item-icon">${itemIcon}</span>
                        <span class="item-type-tag">[${item.type.toUpperCase()}]</span>
                        <span class="item-url-text">${displayUrl}</span>
                        ${durationText}
                    </div>
                    <div class="item-actions">
                        <button class="action-button" onclick="moveItem(${index}, -1)" ${index === 0 ? 'disabled' : ''} title="Elevar Prioridad">üîº</button>
                        <button class="action-button" onclick="moveItem(${index}, 1)" ${index === currentPlaylist.length - 1 ? 'disabled' : ''} title="Bajar Prioridad">üîΩ</button>
                        <button class="action-button danger" onclick="deleteItem(${index})" title="Eliminar de Secuencia">üóëÔ∏è</button>
                    </div>
                `;
                 li.title = `Recurso: ${item.url}`; // Tooltip con URL completa
                playlistListUl.appendChild(li);
            });
        }

        function savePlaylistToFirebase() {
            const playlistToSave = currentPlaylist.map(item => {
                const cleanItem = { url: item.url, type: item.type };
                if (item.type === 'image' || item.type === 'webpage') {
                    cleanItem.duration = parseInt(item.duration) || 10;
                }
                return cleanItem;
            });
            playlistRef.set(playlistToSave)
                .then(() => console.log("SYNCRONIZADO: Secuencia actualizada en la Matrix."))
                .catch(error => console.error("ERROR DE SINCRONIZACI√ìN:", error));
        }

        addItemBtn.addEventListener('click', () => {
            const url = itemUrlInput.value.trim();
            let type = itemTypeSelect.value;
            const duration = parseInt(itemDurationInput.value) || 10;

            if (!url) { alert("ALERTA: URL de Recurso no v√°lida."); return; }

            if (url.includes('youtube.com/watch?') || url.includes('youtu.be/')) {
                 if (type !== 'youtube') {
                     type = 'youtube'; itemTypeSelect.value = 'youtube'; toggleDurationInput();
                 }
            }
            // Re-usar funci√≥n de index.html para validaci√≥n de ID de YouTube
            if (type === 'youtube' && !window.parent.extractVideoID(url) && !extractVideoID(url) ) { // Intenta con la funci√≥n local tambi√©n
                 alert("ALERTA: URL de YouTube inv√°lida o ID no extra√≠ble."); return;
             }

            const newItem = { url, type, duration };
            currentPlaylist.push(newItem);
            savePlaylistToFirebase();
            itemUrlInput.value = ''; itemTypeSelect.value = 'image'; itemDurationInput.value = '10';
            toggleDurationInput();
        });
        // Para que la validaci√≥n de YT funcione, necesitamos la funci√≥n aqu√≠ tambi√©n o referenciarla globalmente
        // Como es una funci√≥n simple, la duplicamos (o podr√≠amos ponerla en un script global)
        function extractVideoID(url) { /* Misma funci√≥n que en index.html */
            try { const urlObj = new URL(url); let videoId = urlObj.searchParams.get('v'); if (!videoId && urlObj.hostname === 'youtu.be') videoId = urlObj.pathname.slice(1); if (videoId && videoId.length === 11) return videoId; } catch (e) {} if (typeof url === 'string' && url.length === 11 && !url.includes('/')) return url; return null;
        }

        window.deleteItem = (index) => {
            if (confirm(`CONFIRMAR ELIMINACI√ìN:\n${currentPlaylist[index].url}\n\n¬øProceder con la purga de este elemento de la secuencia?`)) {
                currentPlaylist.splice(index, 1); savePlaylistToFirebase();
            }
        }
        window.moveItem = (index, direction) => {
             let changed = false;
             if (direction === -1 && index > 0) { [currentPlaylist[index], currentPlaylist[index - 1]] = [currentPlaylist[index - 1], currentPlaylist[index]]; changed = true; }
             else if (direction === 1 && index < currentPlaylist.length - 1) { [currentPlaylist[index], currentPlaylist[index + 1]] = [currentPlaylist[index + 1], currentPlaylist[index]]; changed = true; }
             if (changed) savePlaylistToFirebase();
        }
        playlistRef.on('value', (snapshot) => {
            const data = snapshot.val(); currentPlaylist = data ? Object.values(data) : [];
            renderPlaylist();
        }, (error) => {
            playlistListUl.innerHTML = '<li class="error-list-item">ERROR CR√çTICO: Fallo de conexi√≥n al n√∫cleo de datos.</li>';
        });
    </script>
</body>
</html>