<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control üîí Admin</title>
    <link rel="stylesheet" href="style.css"> <!-- Aseg√∫rate que style.css est√© en la misma carpeta -->
</head>
<body class="control-page">

    <h1>Panel de Control de Contenido</h1>

    <!-- Secci√≥n de Login (Inicialmente visible) -->
    <div id="login-section" class="control-section">
        <h2>Iniciar Sesi√≥n (Admin)</h2>
        <label for="admin-email">Correo Electr√≥nico:</label>
        <input type="email" id="admin-email" required>

        <label for="admin-password">Contrase√±a:</label>
        <input type="password" id="admin-password" required>

        <button id="login-btn">üîë Iniciar Sesi√≥n</button>
        <p id="login-error" class="error-message" style="display: none;"></p>
    </div>

    <!-- Secci√≥n de Controles (Oculta hasta login de ADMIN correcto) -->
    <div id="controls-section" style="display: none;">
        <div class="control-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                 <span id="admin-status"></span>
                 <!-- El ID del bot√≥n debe coincidir con getElementById -->
                 <button id="logout-btn">üö™ Cerrar Sesi√≥n</button>
            </div>
            <h2>A√±adir Nuevo Elemento ‚ú®</h2>
            <label for="item-url">URL del Contenido (Imagen, Video MP4, Web, YouTube):</label>
            <input type="url" id="item-url" placeholder="https://... o https://www.youtube.com/watch?v=..." required>

            <label for="item-type">Tipo:</label>
            <select id="item-type">
                <option value="image">üñºÔ∏è Imagen</option>
                <option value="video">üé¨ Video (MP4 directo)</option>
                <option value="webpage">üåê P√°gina Web</option>
                <option value="youtube">üìπ YouTube Video</option>
            </select>

            <label for="item-duration" id="duration-label">Duraci√≥n (segundos, solo para Imagen/Web):</label>
            <input type="number" id="item-duration" value="10" min="1">

            <button id="add-item-btn">‚ûï A√±adir a la Lista</button>
        </div>

        <div class="control-section">
            <h2>Lista de Reproducci√≥n Actual üìã</h2>
            <ul id="playlist-list">
                <li>Inicia sesi√≥n como administrador para ver/editar...</li>
            </ul>
             <p><small>‚ö†Ô∏è Mover/Eliminar podr√≠a requerir recarga en la TV si ya empez√≥ a mostrarse.</small></p>
        </div>
    </div>

    <!-- SDKs Firebase (app, database, auth) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // --- CONFIGURACI√ìN FIREBASE (CORREGIDA) ---
        const firebaseConfig = {
          apiKey: "AIzaSyAir6pUHwf-vCJ7Tt8yDBpmw4n1jml7oE8",
          authDomain: "visor-negocio.firebaseapp.com",
          // databaseURL: "https://visor-negocio-default-rtdb.firebaseio.com", // <-- COMENTADO
          projectId: "visor-negocio", // <-- VERIFICAR EXACTITUD
          storageBucket: "visor-negocio.appspot.com", // <-- VERIFICAR EXACTITUD
          messagingSenderId: "113061044521",
          appId: "1:113061044521:web:a397b454b03b27da041738"
        };
        // --------------------------------------------------
        // --- UID Admin ---
        const ADMIN_UID = "eRKsZnCe0TXZ4JagmcVAik7IX8T2";
        // -----------------

        // --- INICIALIZACI√ìN Y L√ìGICA DEL PANEL DE CONTROL ---
        try {
             firebase.initializeApp(firebaseConfig);
             console.log("Firebase inicializado correctamente en control.html.");
        } catch (e) {
             console.error("!!! ERROR GRAVE: Fall√≥ firebase.initializeApp() en control.html !!!", e);
             const loginErrorEl = document.getElementById('login-error');
             if(loginErrorEl) { loginErrorEl.textContent = "Error Cr√≠tico: No se pudo inicializar Firebase."; loginErrorEl.style.display = 'block'; }
             throw new Error("Firebase Init Failed");
        }

        const database = firebase.database();
        const auth = firebase.auth();
        const playlistRef = database.ref('playlist');

        // ----- REFERENCIAS A ELEMENTOS DEL DOM -----
        // Es crucial que todas est√©n aqu√≠ antes de usarlas
        const loginSection = document.getElementById('login-section');
        const controlsSection = document.getElementById('controls-section');
        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn'); // <<<--- L√çNEA VERIFICADA Y PRESENTE
        const adminStatus = document.getElementById('admin-status');
        const itemUrlInput = document.getElementById('item-url');
        const itemTypeSelect = document.getElementById('item-type');
        const itemDurationInput = document.getElementById('item-duration');
        const durationLabel = document.getElementById('duration-label');
        const addItemBtn = document.getElementById('add-item-btn');
        const playlistListUl = document.getElementById('playlist-list');
        // -------------------------------------------

        let currentPlaylist = [];
        let dbListenerActive = false;

        // --- Funciones de Autenticaci√≥n ---

        // Listener para el bot√≥n de Login
        loginBtn.addEventListener('click', () => {
             const email = adminEmailInput.value;
             const password = adminPasswordInput.value;
             loginError.style.display = 'none';
             if (!email || !password) {
                 loginError.textContent = 'Por favor, introduce email y contrase√±a.';
                 loginError.style.display = 'block';
                 return;
             }
             auth.signInWithEmailAndPassword(email, password)
                 .then((userCredential) => { console.log("Login OK:", userCredential.user.email); adminPasswordInput.value = ''; })
                 .catch((error) => { console.error("Login Error:", error); loginError.textContent = `Error: ${error.message}`; loginError.style.display = 'block'; });
        });

        // Listener para el bot√≥n de Logout (Esta es la l√≠nea que daba error si logoutBtn no estaba definido antes)
        logoutBtn.addEventListener('click', () => {
             auth.signOut().then(() => { console.log("Logout OK."); })
                 .catch((error) => { console.error("Logout Error:", error); alert("Error al cerrar sesi√≥n."); });
        });

        // Observador del estado de autenticaci√≥n con verificaci√≥n de UID
        auth.onAuthStateChanged(user => {
            console.log("Auth state changed. User:", user ? user.email : 'No user');
            if (user && user.uid === ADMIN_UID) {
                // Es el Administrador correcto
                console.log("Administrador autenticado:", user.email);
                loginSection.style.display = 'none';
                controlsSection.style.display = 'block';
                adminStatus.textContent = `Admin: ${user.email}`;
                loginError.style.display = 'none';

                if (!dbListenerActive) {
                    console.log("Activando listener de DB...");
                    activateDbRead();
                    dbListenerActive = true;
                }
            } else {
                // No est√° logueado O no es el administrador correcto
                console.log("Acceso denegado o no autenticado.");
                loginSection.style.display = 'block';
                controlsSection.style.display = 'none';
                adminStatus.textContent = '';
                playlistListUl.innerHTML = '<li>Inicia sesi√≥n como administrador para ver/editar...</li>';
                currentPlaylist = [];

                if (user) {
                    // Usuario logueado pero NO admin
                    loginError.textContent = 'Error: Usuario no autorizado para administrar.';
                    loginError.style.display = 'block';
                    console.warn("Usuario logueado no es admin (UID:", user.uid, "). Cerrando sesi√≥n.");
                    auth.signOut();
                } else {
                     loginError.style.display = 'none';
                }

                if (dbListenerActive) {
                    console.log("Desactivando listener de DB...");
                    playlistRef.off('value');
                    dbListenerActive = false;
                }
            }
        });


        // --- Funciones de la Playlist ---

        function toggleDurationInput() {
             const selectedType = itemTypeSelect.value;
             if (selectedType === 'video' || selectedType === 'youtube') {
                 itemDurationInput.style.display = 'none'; durationLabel.style.display = 'none';
             } else {
                 itemDurationInput.style.display = 'block'; durationLabel.style.display = 'block';
             }
         }
        itemTypeSelect.addEventListener('change', toggleDurationInput);
        toggleDurationInput();

        function renderPlaylist() {
            console.log("Intentando renderizar playlist. Datos actuales:", currentPlaylist);
            playlistListUl.innerHTML = '';
            if (currentPlaylist.length === 0) {
                playlistListUl.innerHTML = '<li>La lista est√° vac√≠a. ¬°A√±ade algo!</li>';
                return;
            }
            currentPlaylist.forEach((item, index) => {
                 const li = document.createElement('li');
                 let durationText = '';
                 if (item.type !== 'video' && item.type !== 'youtube') { durationText = ` (${item.duration}s)`; }
                 let displayUrl = item.url;
                 if (displayUrl.length > 50) displayUrl = displayUrl.substring(0, 47) + '...';
                 let emoji = item.type === 'image' ? 'üñºÔ∏è' : item.type === 'video' ? 'üé¨' : item.type === 'webpage' ? 'üåê' : item.type === 'youtube' ? 'üìπ' : '‚ùì';
                 li.innerHTML = `
                    <span>${emoji} [${item.type.toUpperCase()}] ${displayUrl}${durationText}</span>
                    <div>
                        <button onclick="moveItem(${index}, -1)" ${index === 0 ? 'disabled' : ''} title="Mover Arriba">üîº</button>
                        <button onclick="moveItem(${index}, 1)" ${index === currentPlaylist.length - 1 ? 'disabled' : ''} title="Mover Abajo">üîΩ</button>
                        <button onclick="deleteItem(${index})" title="Eliminar">‚ùå</button>
                    </div>
                `;
                 li.querySelector('span').title = item.url;
                 playlistListUl.appendChild(li);
            });
        }

        function savePlaylistToFirebase() {
            if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
                 console.error("Intento de guardar por usuario no admin!"); return;
            }
            const playlistToSave = currentPlaylist.map(item => {
                const cleanItem = { url: item.url, type: item.type };
                if (item.type === 'image' || item.type === 'webpage') { cleanItem.duration = parseInt(item.duration) || 10; }
                return cleanItem;
            });
            console.log("Guardando en Firebase:", playlistToSave);
            playlistRef.set(playlistToSave)
                .then(() => console.log("Playlist guardada en Firebase."))
                .catch(error => { console.error("Error guardando playlist:", error); alert(`Error al guardar: ${error.message}`); });
        }

        addItemBtn.addEventListener('click', () => {
            const url = itemUrlInput.value.trim();
            let type = itemTypeSelect.value;
            const duration = parseInt(itemDurationInput.value) || 10;
            if (!url) { alert("URL inv√°lida."); return; }
            if (url.includes('youtube.com/watch?') || url.includes('youtu.be/')) {
                 if (type !== 'youtube') { type = 'youtube'; itemTypeSelect.value = 'youtube'; toggleDurationInput(); }
            }
            if (type === 'youtube' && !extractVideoID(url)) { alert("URL de YouTube inv√°lida."); return; }
            const newItem = { url, type, duration };
            currentPlaylist.push(newItem);
            savePlaylistToFirebase();
            itemUrlInput.value = ''; itemTypeSelect.value = 'image'; itemDurationInput.value = '10'; toggleDurationInput();
        });

        window.deleteItem = (index) => {
             if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) { alert("No autorizado."); return; }
             if (confirm(`¬øEliminar elemento ${index + 1}?\n${currentPlaylist[index].url}`)) {
                currentPlaylist.splice(index, 1);
                savePlaylistToFirebase();
             }
        }
        window.moveItem = (index, direction) => {
            if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) { alert("No autorizado."); return; }
            let changed = false;
             if (direction === -1 && index > 0) { [currentPlaylist[index], currentPlaylist[index - 1]] = [currentPlaylist[index - 1], currentPlaylist[index]]; changed = true; }
             else if (direction === 1 && index < currentPlaylist.length - 1) { [currentPlaylist[index], currentPlaylist[index + 1]] = [currentPlaylist[index + 1], currentPlaylist[index]]; changed = true; }
             if (changed) savePlaylistToFirebase();
        }

        window.extractVideoID = function(url) {
             try {
                const urlObj = new URL(url);
                 let videoId = urlObj.searchParams.get('v');
                 if (!videoId && urlObj.hostname === 'youtu.be') videoId = urlObj.pathname.slice(1);
                 if (videoId && videoId.length === 11) return videoId;
            } catch (e) {}
            if (typeof url === 'string' && url.length === 11 && !url.includes('/')) return url;
            return null;
        }

        // --- Listener de Base de Datos ---
        function activateDbRead() {
            console.log(">>> control.html: Adjuntando listener DB...");
            playlistRef.on('value', (snapshot) => {
                console.log(">>> control.html: Datos recibidos!");
                const data = snapshot.val();
                console.log(">>> control.html: snapshot.val():", data); // Log para ver datos crudos
                currentPlaylist = data ? Object.values(data) : [];
                console.log(">>> control.html: currentPlaylist procesada:", currentPlaylist); // Log para ver array procesado
                renderPlaylist();
            }, (error) => {
                console.error(">>> !!! control.html: ERROR en listener de DB:", error.code, error.message);
                playlistListUl.innerHTML = `<li>ERROR LEYENDO DATOS: ${error.message}</li>`;
            });
        }

        console.log("Panel de control (control.html) inicializado.");

    </script>
</body>
</html>