<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"> <!-- A침adido user-scalable=no -->
    <title>Visor Negocio 游닠</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Forzar pantalla completa y ocultar barras de scroll */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Evita barras de scroll en el body */
            background-color: black; /* Fondo negro por si algo falla */
        }
        /* display-area ahora es el contenedor principal */
        #display-area {
            width: 100%;
            height: 100%;
            display: flex; /* Activa Flexbox */
            justify-content: center; /* Centra contenido horizontalmente */
            align-items: center; /* Centra contenido verticalmente */
            overflow: hidden; /* Asegura que contenido no se desborde */
            background-color: black; /* Fondo negro por defecto */
        }
        /* Ajustes para el contenido dentro del 치rea */
        #display-area img,
        #display-area video {
            display: block; /* Asegura que no haya espacio extra debajo */
            max-width: 100%; /* No m치s ancho que el contenedor */
            max-height: 100%; /* No m치s alto que el contenedor */
            width: auto; /* Mantiene proporci칩n original */
            height: auto; /* Mantiene proporci칩n original */
            object-fit: contain; /* Escala manteniendo proporci칩n, encajando dentro */
        }
        #display-area iframe,
        #youtube-player-container { /* Contenedor para YT */
            width: 100%;
            height: 100%;
            border: none; /* Sin borde */
        }
    </style>
</head>
<body>
    <!-- Toda la pantalla es ahora el 치rea de display -->
    <div id="display-area">
        <!-- El contenido (imagen, video, iframe) se insertar치 aqu칤 din치micamente -->
    </div>

    <!-- Carga as칤ncrona de la API de YouTube -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- SDK de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // ---------------------------------------------------------------
        // --- CONFIGURACI칍N DE FIREBASE (TUS CREDENCIALES) ---
        // ---------------------------------------------------------------
        const firebaseConfig = {
          apiKey: "AIzaSyAir6pUHwf-vCJ7Tt8yDBpmw4n1jml7oE8",
          authDomain: "visor-negocio.firebaseapp.com",
          databaseURL: "https://visor-negocio-default-rtdb.firebaseio.com",
          projectId: "visor-negocio",
          storageBucket: "visor-negocio.appspot.com",
          messagingSenderId: "113061044521",
          appId: "1:113061044521:web:a397b454b03b27da041738"
        };
        // ---------------------------------------------------------------

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const playlistRef = database.ref('playlist');

        let currentPlaylist = [];
        let currentItemIndex = 0;
        let currentTimeoutId = null;
        const displayArea = document.getElementById('display-area');

        let ytPlayer;
        let youtubeApiReady = false;

        function onYouTubeIframeAPIReady() {
            console.log("YouTube API Lista.");
            youtubeApiReady = true;
        }

        function extractVideoID(url) {
             try {
                const urlObj = new URL(url);
                 let videoId = urlObj.searchParams.get('v');
                 if (!videoId && urlObj.hostname === 'youtu.be') {
                    videoId = urlObj.pathname.slice(1);
                 }
                 if (videoId && videoId.length === 11) return videoId;
            } catch (e) { console.error("Error parseando URL YT:", url, e); }
            if (typeof url === 'string' && url.length === 11 && !url.includes('/')) return url;
            return null;
        }

        function cleanupPreviousPlayer() {
            if (currentTimeoutId) clearTimeout(currentTimeoutId);
            currentTimeoutId = null;
            if (ytPlayer && typeof ytPlayer.destroy === 'function') {
                try { ytPlayer.destroy(); console.log("Reproductor YT destruido."); }
                catch(e) { console.error("Error destruyendo YT:", e); }
                ytPlayer = null;
            }
            // Limpiar contenido anterior eficientemente
            while (displayArea.firstChild) {
                displayArea.removeChild(displayArea.firstChild);
            }
             // Asegurar fondo negro mientras carga el siguiente
             displayArea.style.backgroundColor = 'black';
        }

        function playNextItem() {
            cleanupPreviousPlayer();

            if (!currentPlaylist || currentPlaylist.length === 0) {
                console.log("Playlist vac칤a. Esperando...");
                 displayArea.innerHTML = '<p style="color: white; font-size: 1.5em;">Esperando contenido...</p>'; // Mensaje m치s visible
                currentTimeoutId = setTimeout(playNextItem, 5000);
                return;
            }

            if (currentItemIndex >= currentPlaylist.length) {
                currentItemIndex = 0; // Loop
            }

            const item = currentPlaylist[currentItemIndex];
            console.log(`Mostrando item ${currentItemIndex}: ${item.url} (Tipo: ${item.type})`);

            let advanceIndex = true;

            switch (item.type) {
                case 'image':
                    const img = document.createElement('img');
                    img.src = item.url;
                    img.onerror = () => { console.error("Error img:", item.url); playNextItem(); };
                    displayArea.appendChild(img);
                    currentTimeoutId = setTimeout(playNextItem, item.duration * 1000);
                    break;

                case 'video':
                    const video = document.createElement('video');
                    video.src = item.url;
                    video.autoplay = true;
                    video.muted = false; // Intentar con sonido
                    video.controls = false;
                    video.onerror = () => { console.error("Error video:", item.url); playNextItem(); };
                    video.addEventListener('ended', playNextItem);
                    video.addEventListener('error', playNextItem);
                    displayArea.appendChild(video);
                    advanceIndex = false;
                    break;

                case 'webpage':
                    const iframe = document.createElement('iframe');
                    iframe.src = item.url;
                    iframe.onerror = () => { console.warn("Error iframe (puede ser X-Frame-Options):", item.url); };
                    displayArea.appendChild(iframe);
                    currentTimeoutId = setTimeout(playNextItem, item.duration * 1000);
                    break;

                case 'youtube':
                    const videoId = extractVideoID(item.url);
                    if (!videoId) {
                        console.error("No se pudo obtener Video ID de:", item.url);
                        setTimeout(playNextItem, 100); break;
                    }
                    if (!youtubeApiReady) {
                        console.warn("API YouTube no lista, reintentando...");
                        currentTimeoutId = setTimeout(playNextItem, 1000);
                        advanceIndex = false;
                        break;
                    }
                    // Crear DIV contenedor para YT expl칤citamente
                    const ytContainer = document.createElement('div');
                    ytContainer.id = 'youtube-player-container';
                    displayArea.appendChild(ytContainer);

                    ytPlayer = new YT.Player('youtube-player-container', {
                        height: '100%', width: '100%', videoId: videoId,
                        playerVars: {
                            'autoplay': 1, 'controls': 0, 'showinfo': 0, 'rel': 0,
                            'modestbranding': 1, 'loop': 0, 'fs': 0, 'cc_load_policy': 0,
                            'iv_load_policy': 3, 'autohide': 0, 'mute': 0 // Con Sonido
                        },
                        events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange, 'onError': onPlayerError }
                    });
                    advanceIndex = false;
                    break;

                default:
                    console.warn("Tipo desconocido:", item.type);
                    setTimeout(playNextItem, 100);
                    break;
            }

            if(advanceIndex) {
                currentItemIndex++;
            }
        }

        function onPlayerReady(event) {
            console.log("YT Player listo:", event.target.getVideoData().title);
            event.target.playVideo(); // Asegurar inicio
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.ENDED) {
                console.log("Video YT finalizado.");
                currentItemIndex++;
                playNextItem();
            }
            if (event.data == YT.PlayerState.PLAYING) {
                // Opcional: verificar si realmente tiene sonido
                // console.log("YT est치 sonando:", !event.target.isMuted());
            }
        }

        function onPlayerError(event) {
            console.error("Error en YT player:", event.data, "para item:", currentPlaylist[currentItemIndex]?.url);
            currentItemIndex++;
            playNextItem();
        }

        playlistRef.on('value', (snapshot) => {
            const data = snapshot.val();
            const newPlaylist = data ? Object.values(data) : [];
            // Comprobar si la playlist realmente cambi칩 para evitar reinicios innecesarios
            if (JSON.stringify(newPlaylist) !== JSON.stringify(currentPlaylist)) {
                console.log("Playlist actualizada desde Firebase:", newPlaylist);
                currentPlaylist = newPlaylist;
                currentItemIndex = 0; // Reiniciar 칤ndice solo si la lista cambi칩
                 // Cancelar cualquier timeout pendiente antes de reiniciar
                if (currentTimeoutId) clearTimeout(currentTimeoutId);
                currentTimeoutId = null;
                // Detener video o YT si estaba en curso antes de cambiar
                cleanupPreviousPlayer();
                // Empezar la nueva lista
                playNextItem();
            } else {
                console.log("Playlist sin cambios detectados.");
            }

        }, (error) => {
            console.error("Error leyendo Firebase:", error);
            displayArea.innerHTML = '<p style="color: red; font-size: 1.5em;">Error conectando a la Base de Datos.</p>';
        });

        // No iniciar play aqu칤, el listener de Firebase lo har치 cuando lleguen los datos
        console.log("Visor inicializado. Esperando datos de Firebase...");

    </script>
</body>
</html>