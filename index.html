<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Visor Negocio 📺</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos inline para asegurar fullscreen y layout base */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: black; }
        #display-area { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; background-color: black; opacity: 1; transition: opacity 0.6s ease-in-out; }
        #display-area.fading-out { opacity: 0; }
        #display-area img, #display-area video { display: block; max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; }
        #display-area iframe, #youtube-player-container { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>
    <div id="display-area"> <!-- Contenido dinámico --> </div>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // --- CONFIGURACIÓN FIREBASE (CORREGIDA) ---
        // Comentamos databaseURL para que Firebase la derive del projectId
        const firebaseConfig = {
          apiKey: "AIzaSyAir6pUHwf-vCJ7Tt8yDBpmw4n1jml7oE8",
          authDomain: "visor-negocio.firebaseapp.com",
          // databaseURL: "https://visor-negocio-default-rtdb.firebaseio.com", // <-- COMENTADO
          projectId: "visor-negocio", // <-- ASEGÚRATE QUE ESTE SEA EXACTAMENTE CORRECTO
          storageBucket: "visor-negocio.appspot.com", // <-- ASEGÚRATE QUE ESTE SEA CORRECTO
          messagingSenderId: "113061044521",
          appId: "1:113061044521:web:a397b454b03b27da041738"
        };
        // --------------------------------------------------

        // --- INICIALIZACIÓN Y LÓGICA DEL VISOR ---
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase inicializado correctamente en index.html.");
        } catch (e) {
            console.error("!!! ERROR GRAVE: Falló firebase.initializeApp() en index.html !!!", e);
            document.getElementById('display-area').innerHTML = `<p style="color:red; font-size:1.2em; padding:20px;">Error Crítico: No se pudo inicializar Firebase. Verifica la configuración y la conexión.</p>`;
            // Detener ejecución si falla la inicialización
            throw new Error("Firebase Init Failed");
        }

        const database = firebase.database();
        const playlistRef = database.ref('playlist');

        let currentPlaylist = [];
        let currentItemIndex = 0;
        let currentTimeoutId = null;
        const displayArea = document.getElementById('display-area');
        const FADE_DURATION_MS = 600;

        let ytPlayer;
        let youtubeApiReady = false;

        function onYouTubeIframeAPIReady() { /* ... igual que antes ... */ youtubeApiReady = true; }
        function extractVideoID(url) { /* ... igual que antes ... */ }
        function cleanupSpecificPlayers() { /* ... igual que antes ... */ }

        function playNextItem() {
            displayArea.classList.add('fading-out');
            setTimeout(() => {
                cleanupSpecificPlayers();
                while (displayArea.firstChild) { displayArea.removeChild(displayArea.firstChild); }

                if (!currentPlaylist || currentPlaylist.length === 0) {
                    displayArea.innerHTML = '<p style="color: white; font-size: 1.5em;">Esperando contenido...</p>';
                    displayArea.classList.remove('fading-out');
                    console.log("Playlist vacía, esperando actualización.");
                    return;
                }

                if (currentItemIndex >= currentPlaylist.length) { currentItemIndex = 0; }
                const item = currentPlaylist[currentItemIndex];
                console.log(`Mostrando item ${currentItemIndex}: ${item.url} (Tipo: ${item.type})`);
                let advanceIndexManually = true;

                switch (item.type) {
                    case 'image':
                        const img = document.createElement('img');
                        img.src = item.url;
                        img.onerror = () => { console.error("Error img:", item.url); currentItemIndex++; playNextItem(); };
                        displayArea.appendChild(img);
                        currentTimeoutId = setTimeout(playNextItem, item.duration * 1000);
                        break;
                    case 'video':
                        const video = document.createElement('video');
                        video.src = item.url; video.autoplay = true; video.muted = true; // Muted por fiabilidad de autoplay
                        video.controls = false;
                        video.onerror = () => { console.error("Error video:", item.url); currentItemIndex++; playNextItem(); };
                        video.addEventListener('ended', () => { currentItemIndex++; playNextItem(); });
                        displayArea.appendChild(video);
                        advanceIndexManually = false;
                        break;
                    case 'webpage':
                        const iframe = document.createElement('iframe');
                        iframe.src = item.url; iframe.onerror = () => { console.warn("Error iframe:", item.url); };
                        displayArea.appendChild(iframe);
                        currentTimeoutId = setTimeout(playNextItem, item.duration * 1000);
                        break;
                    case 'youtube':
                        const videoId = extractVideoID(item.url);
                        if (!videoId) { /* ...manejar error, saltar... */ setTimeout(() => { currentItemIndex++; playNextItem(); }, 100); advanceIndexManually = false; break; }
                        if (!youtubeApiReady) { /* ...reintentar... */ currentTimeoutId = setTimeout(playNextItem, 1000); advanceIndexManually = false; break; }
                        const ytContainer = document.createElement('div'); ytContainer.id = 'youtube-player-container';
                        displayArea.appendChild(ytContainer);
                        ytPlayer = new YT.Player('youtube-player-container', {
                            height: '100%', width: '100%', videoId: videoId,
                            playerVars: { 'autoplay': 1, 'controls': 0, 'mute': 1 /* Muted */, /* ...otros vars... */ },
                            events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange, 'onError': onPlayerError }
                        });
                        advanceIndexManually = false;
                        break;
                    default:
                        /* ...manejar desconocido, saltar... */ setTimeout(() => { currentItemIndex++; playNextItem(); }, 100); advanceIndexManually = false; break;
                }

                requestAnimationFrame(() => { displayArea.classList.remove('fading-out'); });
                if (advanceIndexManually) { currentItemIndex++; }

            }, FADE_DURATION_MS);
        }

        function onPlayerReady(event) { /* ... igual que antes ... */ event.target.playVideo(); }
        function onPlayerStateChange(event) { /* ... igual que antes ... */ if (event.data == YT.PlayerState.ENDED) { currentItemIndex++; playNextItem(); } }
        function onPlayerError(event) { /* ... igual que antes ... */ console.error("Error en YT player:", event.data); currentItemIndex++; playNextItem(); }

        let initialLoadComplete = false;
        playlistRef.on('value', (snapshot) => {
             console.log(">>> index.html: Datos recibidos de Firebase!"); // Añadido log
             const data = snapshot.val();
             const newPlaylist = data ? Object.values(data) : [];
             if (JSON.stringify(newPlaylist) !== JSON.stringify(currentPlaylist) || !initialLoadComplete) {
                 console.log(">>> index.html: Playlist actualizada:", newPlaylist);
                 currentPlaylist = newPlaylist;
                 currentItemIndex = 0;
                 if (initialLoadComplete) {
                     if (currentTimeoutId) clearTimeout(currentTimeoutId);
                     playNextItem();
                 } else if (currentPlaylist.length > 0) {
                     initialLoadComplete = true;
                     setTimeout(playNextItem, 100);
                 } else {
                      displayArea.innerHTML = '<p style="color: white; font-size: 1.5em;">Playlist vacía...</p>';
                      displayArea.classList.remove('fading-out');
                 }
             }
         }, (error) => {
             console.error(">>> !!! index.html: ERROR en listener de DB:", error.code, error.message);
             displayArea.classList.remove('fading-out');
             displayArea.innerHTML = `<p style="color: red; font-size: 1.5em;">Error leyendo datos: ${error.message}</p>`;
         });

        console.log("Visor (index.html) inicializado. Esperando datos...");
    </script>
</body>
</html>