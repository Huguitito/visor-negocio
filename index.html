<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Visor Negocio 游닠</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos inline para asegurar fullscreen y layout base */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: black; }
        #display-area { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; background-color: black; opacity: 1; transition: opacity 0.6s ease-in-out; }
        #display-area.fading-out { opacity: 0; }
        #display-area img, #display-area video { display: block; max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; }
        #display-area iframe, #youtube-player-container { width: 100%; height: 100%; border: none; }
        #display-area p { color: white; font-size: 1.5em; text-align: center; padding: 40px; } /* Estilo mensajes */
    </style>
</head>
<body>
    <div id="display-area"> <!-- Contenido din치mico --> </div>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // --- CONFIGURACI칍N FIREBASE (CORREGIDA) ---
        const firebaseConfig = {
          apiKey: "AIzaSyAir6pUHwf-vCJ7Tt8yDBpmw4n1jml7oE8",
          authDomain: "visor-negocio.firebaseapp.com",
          // databaseURL: "https://visor-negocio-default-rtdb.firebaseio.com", // <-- COMENTADO
          projectId: "visor-negocio",
          storageBucket: "visor-negocio.appspot.com",
          messagingSenderId: "113061044521",
          appId: "1:113061044521:web:a397b454b03b27da041738"
        };
        // --------------------------------------------------

        // --- INICIALIZACI칍N Y L칍GICA DEL VISOR ---
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("[Visor] Firebase inicializado correctamente.");
        } catch (e) {
            console.error("[Visor] !!! ERROR GRAVE: Fall칩 firebase.initializeApp() !!!", e);
            document.getElementById('display-area').innerHTML = `<p>Error Cr칤tico: No se pudo inicializar Firebase.</p>`;
            throw new Error("Firebase Init Failed");
        }

        const database = firebase.database();
        const playlistRef = database.ref('playlist');

        let currentPlaylist = [];
        let currentItemIndex = 0;
        let currentTimeoutId = null;
        const displayArea = document.getElementById('display-area');
        const FADE_DURATION_MS = 600;

        let ytPlayer;
        let youtubeApiReady = false;

        // --- FUNCIONES AUXILIARES ---
        function onYouTubeIframeAPIReady() {
            console.log("[YT Debug] >>> onYouTubeIframeAPIReady() llamada. API lista."); // LOG YT API
            youtubeApiReady = true;
        }

        function extractVideoID(url) {
            let videoId = null;
            console.log("[YT Debug] Intentando extraer ID de:", url); // LOG URL Entrada
             try {
                const urlObj = new URL(url);
                 videoId = urlObj.searchParams.get('v');
                 if (!videoId && urlObj.hostname === 'youtu.be') {
                    videoId = urlObj.pathname.slice(1);
                 }
                 // Limpiar par치metros extra si los hubiera (ej: &list=...)
                 if (videoId && videoId.includes('&')) {
                    videoId = videoId.split('&')[0];
                 }
                 if (!(videoId && videoId.length === 11)) videoId = null; // Validaci칩n b치sica
            } catch (e) {
                console.warn("[YT Debug] No se pudo parsear como URL completa:", url);
             }
             // Fallback si es solo ID
            if (!videoId && typeof url === 'string' && url.length === 11 && !url.includes('/')) {
                 videoId = url;
             }
            console.log("[YT Debug] ID extra칤do:", videoId); // LOG ID Salida
            return videoId;
        }

        function cleanupSpecificPlayers() {
             if (currentTimeoutId) clearTimeout(currentTimeoutId);
             currentTimeoutId = null;
             if (ytPlayer && typeof ytPlayer.destroy === 'function') {
                 try { ytPlayer.destroy(); console.log("[Visor] Reproductor YT destruido."); }
                 catch(e) { console.error("[Visor] Error destruyendo YT:", e); }
                 ytPlayer = null;
             }
        }

        // --- FUNCI칍N PRINCIPAL DE REPRODUCCI칍N ---
        function playNextItem() {
            console.log(`[Visor] Iniciando playNextItem para 칤ndice ${currentItemIndex}...`);
            displayArea.classList.add('fading-out');

            setTimeout(() => {
                cleanupSpecificPlayers();
                while (displayArea.firstChild) { displayArea.removeChild(displayArea.firstChild); }

                if (!currentPlaylist || currentPlaylist.length === 0) {
                    displayArea.innerHTML = '<p>Esperando contenido...</p>';
                    displayArea.classList.remove('fading-out');
                    console.log("[Visor] Playlist vac칤a, esperando actualizaci칩n.");
                    return;
                }

                if (currentItemIndex >= currentPlaylist.length) { currentItemIndex = 0; }
                const item = currentPlaylist[currentItemIndex];
                console.log(`[Visor] Preparando item ${currentItemIndex}: Tipo=${item.type}, URL=${item.url}`);

                let advanceIndexManually = true;

                switch (item.type) {
                    case 'image':
                        /* ... (igual que antes) ... */
                        const img = document.createElement('img'); img.src = item.url;
                        img.onerror = () => { console.error("[Visor] Error img:", item.url); currentItemIndex++; playNextItem(); };
                        displayArea.appendChild(img);
                        currentTimeoutId = setTimeout(playNextItem, (item.duration || 10) * 1000); // A침adido default duration
                        break;
                    case 'video':
                        /* ... (igual que antes, mute: 1 recomendado) ... */
                        const video = document.createElement('video'); video.src = item.url; video.autoplay = true; video.muted = true; // Muted
                        video.controls = false;
                        video.onerror = () => { console.error("[Visor] Error video:", item.url); currentItemIndex++; playNextItem(); };
                        video.addEventListener('ended', () => { console.log("[Visor] Video MP4 finalizado."); currentItemIndex++; playNextItem(); });
                        displayArea.appendChild(video);
                        advanceIndexManually = false;
                        break;
                    case 'webpage':
                        /* ... (igual que antes) ... */
                         const iframe = document.createElement('iframe'); iframe.src = item.url; iframe.onerror = () => { console.warn("[Visor] Error iframe:", item.url); };
                         displayArea.appendChild(iframe);
                         currentTimeoutId = setTimeout(playNextItem, (item.duration || 10) * 1000); // A침adido default duration
                        break;

                    // --- CASO YOUTUBE CON DEBUGGING ---
                    case 'youtube':
                        console.log("[YT Debug] Procesando item YouTube:", item.url);
                        const videoId = extractVideoID(item.url);

                        if (!videoId) {
                            console.error("[YT Debug] ERROR: No se pudo obtener Video ID v치lido. Saltando item.");
                            setTimeout(() => { currentItemIndex++; playNextItem(); }, 100);
                            advanceIndexManually = false; // Ya estamos avanzando el 칤ndice
                            break; // Salir del switch
                        }

                        if (!youtubeApiReady) {
                            console.warn("[YT Debug] ADVERTENCIA: API YouTube no lista. Reintentando en 1s...");
                            currentTimeoutId = setTimeout(playNextItem, 1000); // Reintentar ESTE MISMO item
                            advanceIndexManually = false; // No avanzar 칤ndice todav칤a
                            break; // Salir del switch
                        }

                        console.log("[YT Debug] API lista. Creando contenedor para YT Player...");
                        const ytContainer = document.createElement('div');
                        ytContainer.id = 'youtube-player-container';
                        displayArea.appendChild(ytContainer);

                        console.log(`[YT Debug] Llamando a new YT.Player con ID: ${videoId}`);
                        try {
                             ytPlayer = new YT.Player('youtube-player-container', {
                                height: '100%', width: '100%', videoId: videoId,
                                playerVars: {
                                    'autoplay': 1, 'controls': 0, 'showinfo': 0, 'rel': 0,
                                    'modestbranding': 1, 'loop': 0, 'fs': 0, 'cc_load_policy': 0,
                                    'iv_load_policy': 3, 'autohide': 0,
                                    'mute': 1 // Muted para autoplay fiable
                                },
                                events: {
                                    'onReady': onPlayerReady,
                                    'onStateChange': onPlayerStateChange,
                                    'onError': onPlayerError
                                }
                            });
                             console.log("[YT Debug] YT.Player instanciado (esperando eventos).");
                        } catch (e) {
                             console.error("[YT Debug] !!! ERROR CR칈TICO al instanciar YT.Player:", e);
                             // Si falla la creaci칩n, saltar al siguiente item
                             setTimeout(() => { currentItemIndex++; playNextItem(); }, 100);
                        }
                        advanceIndexManually = false; // Los eventos se encargar치n
                        break; // Fin case 'youtube'

                    default:
                        /* ... (igual que antes) ... */
                        console.warn("[Visor] Tipo desconocido:", item.type);
                        setTimeout(() => { currentItemIndex++; playNextItem(); }, 100);
                        advanceIndexManually = false;
                        break;
                }

                // Fade In (igual que antes)
                requestAnimationFrame(() => { displayArea.classList.remove('fading-out'); });
                // Avanzar 칤ndice si corresponde (igual que antes)
                if (advanceIndexManually) { currentItemIndex++; }

            }, FADE_DURATION_MS); // Fin setTimeout principal
        } // Fin playNextItem

        // --- HANDLERS DE EVENTOS YOUTUBE CON DEBUGGING ---
        function onPlayerReady(event) {
            console.log("[YT Debug] >>> Evento: onPlayerReady disparado para video:", event.target.getVideoData().title);
            // playVideo() puede ser necesario aunque autoplay=1
            try {
                 event.target.playVideo();
                 console.log("[YT Debug] onPlayerReady: playVideo() llamado.");
            } catch (e) {
                 console.error("[YT Debug] onPlayerReady: Error llamando a playVideo():", e);
            }
        }

        function onPlayerStateChange(event) {
            let stateName = 'UNKNOWN';
            switch(event.data) {
                case -1: stateName = 'UNSTARTED'; break;
                case YT.PlayerState.ENDED: stateName = 'ENDED'; break;
                case YT.PlayerState.PLAYING: stateName = 'PLAYING'; break;
                case YT.PlayerState.PAUSED: stateName = 'PAUSED'; break;
                case YT.PlayerState.BUFFERING: stateName = 'BUFFERING'; break;
                case YT.PlayerState.CUED: stateName = 'CUED'; break;
            }
            console.log(`[YT Debug] >>> Evento: onStateChange disparado. Nuevo estado: ${event.data} (${stateName})`);

            if (event.data == YT.PlayerState.ENDED) {
                console.log("[YT Debug] Estado ENDED detectado. Avanzando al siguiente item...");
                currentItemIndex++;
                playNextItem();
            }
            // Podr칤as a침adir l칩gica aqu칤 si se queda en PAUSED o BUFFERING mucho tiempo
        }

        function onPlayerError(event) {
            // C칩digos de error comunes: 2 (ID inv치lido), 5 (error HTML5), 100 (no encontrado), 101/150 (prohibido embeber)
            console.error(`[YT Debug] !!! >>> Evento: onError disparado. C칩digo de error: ${event.data}`);
            currentItemIndex++;
            playNextItem(); // Saltar al siguiente
        }

        // --- LISTENER FIREBASE (igual que antes) ---
        initialLoadComplete = false;
        playlistRef.on('value', (snapshot) => {
            // ... (l칩gica igual que antes para actualizar currentPlaylist y llamar a playNextItem) ...
             console.log("[Visor] Datos recibidos de Firebase!");
             const data = snapshot.val();
             const newPlaylist = data ? Object.values(data) : [];
             if (JSON.stringify(newPlaylist) !== JSON.stringify(currentPlaylist) || !initialLoadComplete) {
                 console.log("[Visor] Playlist actualizada/inicial:", newPlaylist);
                 currentPlaylist = newPlaylist;
                 currentItemIndex = 0;
                 if (initialLoadComplete) {
                     if (currentTimeoutId) clearTimeout(currentTimeoutId);
                     playNextItem();
                 } else if (currentPlaylist.length > 0) {
                     console.log("[Visor] Carga inicial completa, iniciando reproducci칩n...");
                     initialLoadComplete = true;
                     setTimeout(playNextItem, 100); // Peque침o delay post-carga inicial
                 } else {
                      console.log("[Visor] Carga inicial, lista vac칤a.");
                      displayArea.innerHTML = '<p>Playlist vac칤a...</p>';
                      displayArea.classList.remove('fading-out');
                 }
             } else {
                 console.log("[Visor] Playlist recibida sin cambios.");
             }
         }, (error) => {
            console.error("[Visor] !!! ERROR en listener de DB:", error.code, error.message);
            displayArea.classList.remove('fading-out');
            displayArea.innerHTML = `<p>Error leyendo datos: ${error.message}</p>`;
         });

        console.log("[Visor] index.html inicializado. Esperando datos...");
    </script>
</body>
</html>